# WooCommerce Security Repo

This is the repository used for staging security fixes for projects within the WooCommerce monorepo. This guide primarily covers the process as it concerns a 
WooCommerce Core release, 
but, except for the build steps, the general process should be applicable towards other projects in the repository.
  
> **Warning** <br> <br>
> The default branch for this repository is `security`, and not `trunk`, as it is within the monorepo. <br>
> This branch will be kept in sync with `trunk`, with some exceptions, such as this README file.<br>
> Your changes should target the specific release branch that you're targeting. [Read more below](#notes-about-the-security-and-security-base-branches).

## Preparing a security fix.

The `trunk` branch along with branches matching the pattern `release/*` are synced from the public monorepo repository. This sync happens approximately once each 
hour, via automation. 

1. If your target branch hasn't been synced recently, you can manually run [this action](.github/workflows/security-sync.yml).
2. Clone this repository, or if it's already cloned, pull down your target branch and make sure it's up to date locally.
3. Create a new branch from your target branch, for example `git checkout fix/my-fix release/7.0`.
4. Make your changes locally and commit to your fix branch. Push that branch to origin, for example `git push origin fix/my-fix`.
5. Create a PR against your target branch.
6. If your fix needs to target additional release branches, if the same branch applies cleanly, you can make multiple PRs against your various target branches.
7. Once your PR is ready to be included in the release build, *instead of merging it to the target branch*, add the label `Ready for Build`. You should only do this 
if your PR has no conflicts with its base branch and can be merged automatically.
8. If you'd like to test the zip that includes your fix PR, you can generate that using [this action](.github/workflows/security-build-zip.yml).
9. The release team will build any Betas, RCs, or patch releases with your PR.

## Preparing a release with security fixes.

If you're a release lead preparing a release with a security fix, you'll follow the steps below:

For any release (beta / rc / final / or fix release):

1. Make sure that the release branch in this repository is up to date. This happens hourly, but you can also manually run [this 
action](.github/workflows/security-sync.yml).
2. Make sure that any fix PRs that need to be included in the release have the label `Ready for Build` and that they are capable of being merged automatically.
3. Generate the release zip using [this action](.github/workflows/security-build-zip.yml).

After a final or fix release:

1. Cherry-pick the PRs from the security repo into the public repository's release branch.
2. Cherry-pick the PRs from the security repo into trunk of the public repository.

## Notes about the `security` and `security-base` branches

Because many aspects of GitHub actions only work from the default branch, the default branch in this repository is `security`. When the `trunk` branch is synced to 
this repository, the 
`security` repository is generated by taking the contents of `trunk` and applying the contents of `security-base` on top of that.

If you need to persist any changes to the `security` repo, they should be applied to `security-base`.
