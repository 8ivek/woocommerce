name: Smoke k6 test daily
on: push
jobs:
  woocommerce-k6-daily-smoke-ext:
    name: Run k6 smoke test using trunk on ext site.
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
        with:
            ref: trunk

      - uses: ./.github/actions/cache-deps
        with:
          workflow_name: smoke-test-daily
          workflow_cache: ${{ secrets.WORKFLOW_CACHE }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'

      - name: Install and Build
        uses: ./.github/actions/install-build

      - name: Install Jest
        run: npm install -g jest
          
      - name: Run e2e woocommerce update to setup ext site.
        working-directory: plugins/woocommerce
        env:
          SMOKE_TEST_URL: ${{ secrets.SMOKE_TEST_PERF_URL }}
          SMOKE_TEST_ADMIN_USER: ${{ secrets.SMOKE_TEST_PERF_ADMIN_USER }}
          SMOKE_TEST_ADMIN_PASSWORD: ${{ secrets.SMOKE_TEST_PERF_ADMIN_PASSWORD }}
          SMOKE_TEST_ADMIN_USER_EMAIL: ${{ secrets.SMOKE_TEST_ADMIN_USER_EMAIL }}
          SMOKE_TEST_CUSTOMER_USER: ${{ secrets.SMOKE_TEST_CUSTOMER_USER }}
          SMOKE_TEST_CUSTOMER_PASSWORD: ${{ secrets.SMOKE_TEST_CUSTOMER_PASSWORD }}
          WC_E2E_SCREENSHOTS: 1
          E2E_RETEST: 1
          E2E_RETRY_TIMES: 0
          E2E_SLACK_TOKEN: ${{ secrets.SMOKE_TEST_SLACK_TOKEN }}
          E2E_SLACK_CHANNEL: ${{ secrets.SMOKE_TEST_SLACK_CHANNEL }}
          UPDATE_WC: 1
          DEFAULT_TIMEOUT_OVERRIDE: 120000
        run: |
          pnpx wc-e2e test:e2e tests/e2e/specs/smoke-tests/update-woocommerce.js
        continue-on-error: true

      - name: Install k6
        run: |
            curl https://github.com/grafana/k6/releases/download/v0.33.0/k6-v0.33.0-linux-amd64.tar.gz -L | tar xvz --strip-components 1

      - name: Run k6 tests
        env:
            URL: ${{ secrets.SMOKE_TEST_PERF_URL }}
            HOST: ${{ secrets.SMOKE_TEST_PERF_HOST }}
            A_USER: ${{ secrets.SMOKE_TEST_PERF_ADMIN_USER }}
            A_PW: ${{ secrets.SMOKE_TEST_PERF_ADMIN_PASSWORD }}
            C_USER: ${{ secrets.SMOKE_TEST_PERF_ADMIN_USER }}
            C_PW: ${{ secrets.SMOKE_TEST_PERF_ADMIN_PASSWORD }}
            P_ID: 274

        run: |
            ./k6 run plugins/woocommerce/tests/performance/tests/gh-action-pr-requests.js
