name: Performance metrics

on:
    pull_request:
        paths:
            - 'plugins/woocommerce/**'
            - '.github/workflows/pr-assess-performance.yml'

concurrency:
    group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
    cancel-in-progress: true

jobs:
    build:
        name: Evaluate performance metrics
        runs-on: ubuntu-latest
        permissions:
            pull-requests: write

        steps:
            - uses: actions/checkout@v4
              name: Checkout (latest)
              with:
                fetch-depth: 0

            - uses: ./.github/actions/setup-woocommerce-monorepo
              name: Install Monorepo
              with:
                install: '@woocommerce/plugin-woocommerce...'
                build: '@woocommerce/plugin-woocommerce'
                build-type: 'full'
                pull-playwright-cache: true
                pull-package-deps: '@woocommerce/plugin-woocommerce'

            - name: Start Test Environment
              run: |
                pnpm --filter="@woocommerce/plugin-woocommerce" test:e2e:install &
                pnpm --filter="@woocommerce/plugin-woocommerce" env:test

            - name: Measure performance (@latest)
              env:
                WP_ARTIFACTS_PATH: 'tools/compare-perf/artifacts/'
              run: |
                RESULTS_ID="editor_${{ github.sha }}_round-1" pnpm --filter="@woocommerce/plugin-woocommerce" test:metrics editor
                RESULTS_ID="product-editor_${{ github.sha }}_round-1" pnpm --filter="@woocommerce/plugin-woocommerce" test:metrics product-editor
              
            - name: Checkout (baseline)
              run: |
                git reset --hard
                git checkout trunk
                echo "WC_TRUNK_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV

            - uses: actions/download-artifact@v4
              name: Download measurements artifacts (baseline)
              with:
                name: woocommerce-performance-measures-${{ env.WC_TRUNK_SHA }}

            - name: Verify measurements artifacts (baseline)
              run: |
                if test -n "$(find tools/compare-perf/artifacts/ -maxdepth 1 -name '*_${{ env.WC_TRUNK_SHA }}_*' -print -quit)"
                then
                  echo "WC_MEASURE_BASELINE='no'" >> $GITHUB_ENV
                else
                  echo "WC_MEASURE_BASELINE='yes'" >> $GITHUB_ENV
                fi
            
            - name: Rebuild
              if: ${{ env.WC_MEASURE_BASELINE }}
              run: |
                git clean -n -d -X ./packages ./plugins | grep -v vendor | grep -v node_modules | sed -e 's/Would remove //g' | tr '\n' '\0' | xargs -0 rm -r 
                pnpm install --filter='@woocommerce/plugin-woocommerce...' --frozen-lockfile --config.dedupe-peer-dependents=false
                pnpm --filter='@woocommerce/plugin-woocommerce' build

            - name: Measure performance (@trunk)
              if: ${{ env.WC_MEASURE_BASELINE }}
              env:
                WP_ARTIFACTS_PATH: 'tools/compare-perf/artifacts/'
              run: |
                RESULTS_ID="editor_${{ env.WC_TRUNK_SHA }}_round-1" pnpm --filter="@woocommerce/plugin-woocommerce" test:metrics editor
                RESULTS_ID="product-editor_${{ env.WC_TRUNK_SHA }}_round-1" pnpm --filter="@woocommerce/plugin-woocommerce" test:metrics product-editor

            - name: Upload measurements artifacts (baseline)
              if: ${{ env.WC_MEASURE_BASELINE }}
              uses: actions/upload-artifact@v4
              with:
                name: woocommerce-performance-measures-${{ env.WC_TRUNK_SHA }}
                path: tools/compare-perf/artifacts/*_${{ env.WC_TRUNK_SHA }}_*
                compression-level: 9
                retention-days: 7
            
            # Calculating/Printing results
            # Publish to CodeVitals (see .github/workflows/scripts/run-metrics.sh)
